
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  //directUrl = env("DIRECT_URL")
}
        

// Model for general CMS pages (Home, About, Services, etc.)
model Page {
  id           Int                @id @default(autoincrement())
  name         String
  slug         String?            @unique
  sections     Section[]          // Page is composed of multiple sections
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([slug])
}

// Sections that make up a Page. Each Section has multilingual content via translations.
model Section {
  id        Int                   @id @default(autoincrement())
  name      String               
  page      Page                  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  pageId    Int
  translations SectionTranslation[]
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([pageId])
  @@unique([pageId, name])
}

// Translations for Section content (multilingual support per section)
model SectionTranslation {
  id         Int      @id @default(autoincrement())
  section    Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  sectionId  Int
  locale     String   // e.g., "en", "es"
  content    Json     // Rich content or structured data per locale
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([sectionId, locale])
  @@index([locale])
}

// Video content catalog (e.g., YouTube embeds)
enum VideoType {
  VIDEO
  PLAYLIST
}

model Video {
  id            Int              @id @default(autoincrement())
  title         String
  description   String?
  embedUrl      String           // e.g., YouTube video or playlist URL/ID
  videoType     VideoType        @default(VIDEO)
  // Optional category for grouping videos
  category      VideoCategory?   @relation(fields: [categoryId], references: [id])
  categoryId    Int?
  // Many-to-many tags for videos
  tags          Tag[]            @relation("VideoTags")
  // Many-to-many relation: videos can be associated with products
  products      Product[]        @relation("ProductVideos")
  datePublished DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([datePublished])
}

// Categories specifically for videos (topics, series, etc.)
model VideoCategory {
  id       Int      @id @default(autoincrement())
  name     String
  slug     String   @unique
  videos   Video[]
}

// Tag type enum
enum TagType {
  VIDEO
  PRODUCT
}

// General tags for various content (applies to products, videos, etc.)
model Tag {
  id       Int       @id @default(autoincrement())
  name     String    
  type     TagType   // VIDEO or PRODUCT
  // Relations for many-to-many tagging
  products Product[] @relation("ProductTags")
  videos   Video[]   @relation("VideoTags")

  @@unique([name, type]) // Unique name per type
}

// Brand or manufacturer for products
model Brand {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  slug     String    @unique
  products Product[]
}

// Product catalog
model Product {
  id           Int                   @id @default(autoincrement())
  sku          String                @unique   // Optional product code
  brand        Brand                 @relation(fields: [brandId], references: [id])
  brandId      Int
  // Many-to-many categories for products (e.g., multiple category tags)
  categories   ProductCategory[]     @relation("ProductCategories")
  // Many-to-many tags for products
  tags         Tag[]                 @relation("ProductTags")
  // Product images and metadata
  images       ProductImage[]
  // Translatable content (name, description, SEO) 
  translations ProductTranslation[]
  // Associated videos (many-to-many)
  videos       Video[]               @relation("ProductVideos")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  @@index([brandId])
}

// Categories for products
model ProductCategory {
  id       Int       @id @default(autoincrement())
  name     String
  slug     String    @unique
  products Product[] @relation("ProductCategories")
}

// Translations for product content (supporting multiple locales)
model ProductTranslation {
  id             Int      @id @default(autoincrement())
  product        Product  @relation(fields: [productId], references: [id])
  productId      Int
  locale         String
  name           String
  slug           String
  description    String   @db.Text // Rich description text
  // Optional SEO fields
  seoTitle       String?
  seoDescription String?
  canonicalUrl   String?
  // Content versioning for future
  version        Int      @default(1)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([productId, locale])    // Unique translation per product & locale
  @@unique([slug, locale])         // Unique slug per locale (if product URLs are localized)
}

// Metadata for product images (one-to-many)
model ProductImage {
  id        Int     @id @default(autoincrement())
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  url       String
  alt       String?
  width     Int?
  height    Int?
  position  Int?    // ordering index if multiple images
}

// Customer or client testimonials
model Testimonial {
  id          Int      @id @default(autoincrement())
  content     String
  author      String
  // Additional fields like authorTitle, company, rating could be added
  isPublished Boolean  @default(false) // To allow moderation
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Contact form submissions from users
model ContactSubmission {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  phone     String?
  subject   String?
  message   String   @db.Text
  createdAt DateTime @default(now())
}

// User accounts for CMS administration
model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  password     String
  name         String?
  role         Role      @relation(fields: [roleId], references: [id])
  roleId       Int
  refreshToken String?   // Store hashed refresh token
  otps         Otp[]      // One-to-many relation with OTPs
  sessions     Session[] // One-to-many relation with sessions
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// OTP (One-Time Password) model for password reset and verification
model Otp {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  code      String   // Store hashed OTP code
  type      OtpType  @default(PASSWORD_RESET) // Type of OTP (password reset, email verification, etc.)
  expiresAt DateTime // OTP expiration time
  isUsed    Boolean  @default(false) // Track if OTP has been used
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
}

// Session management model
model Session {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  tokenId     String   @unique // JWT ID (jti) for tracking
  deviceInfo  Json?    // Device/browser information
  ipAddress   String?
  userAgent   String?
  location    String?  // Geographic location if available
  isActive    Boolean  @default(true)
  isCurrent   Boolean  @default(false) // Mark current session
  lastUsed    DateTime @default(now())
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  activities  SessionActivity[] // One-to-many relation with activities

  @@index([userId])
  @@index([tokenId])
  @@index([expiresAt])
  @@index([isActive])
}

// Session activity log for security monitoring
model SessionActivity {
  id        Int      @id @default(autoincrement())
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String
  action    String   // LOGIN, REFRESH, LOGOUT, SUSPICIOUS_ACTIVITY
  ipAddress String?
  userAgent String?
  details   Json?    // Additional context
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([action])
  @@index([createdAt])
}

// Role/permission model (can be extended with many-to-many for more complex permissions)
model Role {
  id       Int      @id @default(autoincrement())
  name     UserRole @unique
  users    User[]
}

// Navigation menus (configurable in CMS)
model Menu {
  id    Int    @id @default(autoincrement())
  name  String
  items Json   // JSON structure for menu items (label, link, order, etc.)
}

// User role enum
enum UserRole {
  ADMIN
  USER
}

// CSRF token model for protection against Cross-Site Request Forgery
model CsrfToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique // The CSRF token value
  sessionId String?  // Optional session ID for session-based tokens
  userId    Int?     // Optional user ID for user-based tokens
  expiresAt DateTime // Token expiration time
  createdAt DateTime @default(now())

  @@index([token])
  @@index([sessionId])
  @@index([userId])
  @@index([expiresAt])
}

// OTP type enum
enum OtpType {
  PASSWORD_RESET
  EMAIL_VERIFICATION
  TWO_FACTOR_AUTH
  ACCOUNT_RECOVERY
}